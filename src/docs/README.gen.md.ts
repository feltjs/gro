import {dirname, relative, basename} from 'path';
import {to_path_parts, to_path_segments} from '@feltcoop/felt/util/path_parsing.js';
import {last} from '@feltcoop/felt/util/array.js';
import {strip_start} from '@feltcoop/felt/util/string.js';

import {Gen, to_output_file_name} from '../gen/gen.js';
import {paths, base_path_to_source_id} from '../paths.js';

// This renders a simple index of a possibly nested directory of files.

// TODO look at `tasks.gen.md.ts` to refactor and generalize
// TODO show nested structure, not a flat list
// TODO work with file types beyond markdown

export const gen: Gen = async ({fs, origin_id}) => {
	// TODO need to get this from project config or something
	const root_path = last(to_path_segments(paths.root));

	const origin_dir = dirname(origin_id);
	const origin_base = basename(origin_id);

	const base_dir = paths.source;
	const relative_path = strip_start(origin_id, base_dir);
	const relative_dir = dirname(relative_path);

	// TODO should this be passed in the context, like `defaultOutputFileName`?
	const output_file_name = to_output_file_name(origin_base);

	// TODO this is GitHub-specific
	const root_link = `[${root_path}](/../..)`;

	const doc_files = await fs.find_files(origin_dir);
	const doc_paths: string[] = [];
	for (const [path, stats] of doc_files) {
		if (stats.isDirectory() || path === output_file_name || !path.endsWith('.md')) {
			continue;
		}
		doc_paths.push(path);
	}
	const docs = doc_paths;

	// TODO do we want to use absolute paths instead of relative paths,
	// because GitHub works with them and it simplifies the code?
	const is_index_file = output_file_name === 'README.md';
	const path_parts = to_path_parts(relative_dir).map((relative_path_part) =>
		is_index_file && relative_path_part === relative_dir
			? relative_path_part
			: `[${last(to_path_segments(relative_path_part))}](${
					relative(origin_dir, base_path_to_source_id(relative_path_part)) || './'
			  })`,
	);
	const breadcrumbs =
		'> <sub>' + [root_link, ...path_parts, output_file_name].join(' / ') + '</sub>';

	// TODO render the footer with the origin_id
	return `# docs

${breadcrumbs}

${docs.reduce((doc_list, doc) => doc_list + `- [${basename(doc, '.md')}](${doc})\n`, '')}
${breadcrumbs}

> <sub>generated by [${origin_base}](${origin_base})</sub>
`;
};
