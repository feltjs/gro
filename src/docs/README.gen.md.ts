import {dirname, relative, basename} from 'path';
import {toPathParts, to_path_segments} from '@feltcoop/felt/utils/path.js';
import {last} from '@feltcoop/felt/utils/array.js';
import {strip_start} from '@feltcoop/felt/utils/string.js';

import {Gen, toOutputFileName} from '../gen/gen.js';
import {paths, base_path_to_source_id} from '../paths.js';

// This renders a simple index of a possibly nested directory of files.

// TODO look at `tasks.gen.md.ts` to refactor and generalize
// TODO show nested structure, not a flat list
// TODO work with file types beyond markdown

export const gen: Gen = async ({fs, origin_id}) => {
	// TODO need to get this from project config or something
	const rootPath = last(to_path_segments(paths.root));

	const originDir = dirname(origin_id);
	const originBase = basename(origin_id);

	const baseDir = paths.source;
	const relativePath = strip_start(origin_id, baseDir);
	const relativeDir = dirname(relativePath);

	// TODO should this be passed in the context, like `defaultOutputFileName`?
	const outputFileName = toOutputFileName(originBase);

	// TODO this is GitHub-specific
	const rootLink = `[${rootPath}](/../..)`;

	const docFiles = await fs.find_files(originDir);
	const docPaths: string[] = [];
	for (const [path, stats] of docFiles) {
		if (stats.isDirectory() || path === outputFileName || !path.endsWith('.md')) {
			continue;
		}
		docPaths.push(path);
	}
	const docs = docPaths;

	// TODO do we want to use absolute paths instead of relative paths,
	// because GitHub works with them and it simplifies the code?
	const isIndexFile = outputFileName === 'README.md';
	const pathParts = toPathParts(relativeDir).map((relativePathPart) =>
		isIndexFile && relativePathPart === relativeDir
			? relativePathPart
			: `[${last(to_path_segments(relativePathPart))}](${
					relative(originDir, base_path_to_source_id(relativePathPart)) || './'
			  })`,
	);
	const breadcrumbs = '> <sub>' + [rootLink, ...pathParts, outputFileName].join(' / ') + '</sub>';

	// TODO render the footer with the origin_id
	return `# docs

${breadcrumbs}

${docs.reduce((docList, doc) => docList + `- [${basename(doc, '.md')}](${doc})\n`, '')}
${breadcrumbs}

> <sub>generated by [${originBase}](${originBase})</sub>
`;
};
